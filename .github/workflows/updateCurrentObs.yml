name: Update Current Observation

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write   # <-- REQUIRED for git push using GITHUB_TOKEN

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure data/xml folder exists
        run: mkdir -p data/xml

      - name: Download XML file
        run: |
          curl -s https://reg.bom.gov.au/fwo/IDS60920.xml -o data/xml/IDS60920.xml

      - name: Install XML parser
        run: npm install xml2js

      - name: Parse XML for selected station
        run: |
            node << 'EOF'
            const fs = require("fs");
            const xml2js = require("xml2js");

            const xml = fs.readFileSync("data/xml/IDS60920.xml", "utf8");
            const targetStation = process.env.STATION || "NOARLUNGA";

            xml2js.parseString(xml, { explicitArray: true }, (err, res) => {
            if (err) throw err;

            const stations =
                res.product.observations?.[0]?.station || [];

            const match = stations.find(
                s => s.$["stn-name"]?.toUpperCase() === targetStation.toUpperCase()
            );

            if (!match) {
                console.error("Station not found:", targetStation);
                console.log("Available stations:");
                console.log(stations.map(s => s.$["stn-name"]));
                process.exit(1);
            }

            const latestPeriod = match.period?.[0]?.level?.[0]?.element || [];

            const tempElement = latestPeriod.find(
                el => el.$.type === "air_temperature"
            );

            if (!tempElement) {
                console.error("No air_temperature element found for station", targetStation);
                process.exit(1);
            }

            const currentTemp = parseFloat(tempElement._);

            const output = {
                station: targetStation,
                observed_at: match.period[0].$["time-local"],
                air_temperature: currentTemp
            };

            fs.writeFileSync("data/currentObs.json", JSON.stringify(output, null, 2));
            console.log("Current obs written:", output);
            });
            EOF
        env:
            STATION: "NOARLUNGA"


      - name: Commit changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add data/currentObs.json data/xml/IDS60920.xml
          git commit -m "Update current observations" || echo "No changes"
          git push
